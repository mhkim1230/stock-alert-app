<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“± MY ì¦ê¶Œ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f8f9fa;
            color: #1a1a1a;
            line-height: 1.5;
        }
        
        .app-container { 
            max-width: 428px; 
            margin: 0 auto; 
            background: white;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .top-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 50px 20px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .top-bar h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .top-bar p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .tab-nav {
            background: white;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            position: sticky;
            top: 89px;
            z-index: 99;
        }
        
        .tab-btn {
            flex: 1;
            padding: 16px 8px;
            background: none;
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            color: #8e8e93;
            cursor: pointer;
            position: relative;
        }
        
        .tab-btn.active {
            color: #667eea;
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #667eea;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            padding-bottom: 100px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section {
            margin-bottom: 32px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a1a1a;
        }
        
        .add-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .add-btn:hover {
            background: #5a67d8;
        }
        
        .stock-card, .alert-card, .news-card {
            background: white;
            border: 1px solid #f1f3f4;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }
        
        .stock-card:hover, .alert-card:hover, .news-card:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .stock-info h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 2px;
        }
        
        .stock-info p {
            font-size: 0.8rem;
            color: #8e8e93;
        }
        
        .stock-price {
            text-align: right;
        }
        
        .price {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1a1a1a;
        }
        
        .change {
            font-size: 0.8rem;
            font-weight: 500;
            margin-top: 2px;
        }
        
        .positive { color: #ff6b35; }
        .negative { color: #3182f6; }
        
        .stock-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid #f8f9fa;
        }
        
        .alert-status {
            font-size: 0.75rem;
            color: #8e8e93;
        }
        
        .alert-active {
            color: #ff6b35;
            font-weight: 500;
        }
        
        .action-btns {
            display: flex;
            gap: 8px;
        }
        
        .btn-small {
            background: #f8f9fa;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.75rem;
            color: #6c757d;
            cursor: pointer;
        }
        
        .btn-small:hover {
            background: #e9ecef;
        }
        
        .btn-alert {
            background: #fff5f5;
            color: #ff6b35;
        }
        
        .btn-alert:hover {
            background: #fee2e2;
        }
        
        /* ì•Œë¦¼ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .alert-card {
            border-left: 4px solid #667eea;
        }
        
        .alert-card h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
        }
        
        .alert-condition {
            font-size: 0.8rem;
            color: #667eea;
            margin-bottom: 4px;
        }
        
        .alert-time {
            font-size: 0.7rem;
            color: #8e8e93;
        }
        
        /* ë‰´ìŠ¤ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .news-card {
            cursor: pointer;
        }
        
        .news-header {
            display: flex;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .news-image {
            width: 60px;
            height: 60px;
            background: #f1f3f4;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #8e8e93;
        }
        
        .news-content {
            flex: 1;
        }
        
        .news-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #1a1a1a;
            line-height: 1.4;
            margin-bottom: 4px;
        }
        
        .news-summary {
            font-size: 0.8rem;
            color: #8e8e93;
            line-height: 1.3;
            margin-bottom: 8px;
        }
        
        .news-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.7rem;
            color: #8e8e93;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #8e8e93;
        }
        
        .empty-state i {
            font-size: 2rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1a1a1a;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #8e8e93;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: #1a1a1a;
            margin-bottom: 8px;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn-primary {
            width: 100%;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
        }
        
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-top: 8px;
        }
        
        .search-item {
            padding: 12px;
            border-bottom: 1px solid #f8f9fa;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .search-item:hover {
            background: #f8f9fa;
        }
        
        .search-item:last-child {
            border-bottom: none;
        }
        
        .search-info h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 2px;
        }
        
        .search-info p {
            font-size: 0.8rem;
            color: #8e8e93;
        }
        
        .search-price {
            text-align: right;
            font-size: 0.8rem;
            color: #1a1a1a;
        }
        
        /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a1a;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .toast.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="top-bar">
            <h1>MY ì¦ê¶Œ</h1>
            <p>ë‚˜ë§Œì˜ ìŠ¤ë§ˆíŠ¸ íˆ¬ì í”Œë«í¼</p>
        </div>
        
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('portfolio')">
                <i class="fas fa-chart-line"></i> í¬íŠ¸í´ë¦¬ì˜¤
            </button>
            <button class="tab-btn" onclick="switchTab('alerts')">
                <i class="fas fa-bell"></i> ì•Œë¦¼
            </button>
            <button class="tab-btn" onclick="switchTab('news')">
                <i class="fas fa-newspaper"></i> íˆ¬ìë‰´ìŠ¤
            </button>
        </div>
        
        <!-- í¬íŠ¸í´ë¦¬ì˜¤ íƒ­ -->
        <div id="portfolio-tab" class="tab-content active">
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">ğŸ“ˆ ê´€ì‹¬ ì£¼ì‹</h2>
                    <button class="add-btn" onclick="openStockModal()">
                        <i class="fas fa-plus"></i> ì¶”ê°€
                    </button>
                </div>
                <div id="stock-list">
                    <div class="empty-state">
                        <i class="fas fa-chart-line"></i>
                        <p>ê´€ì‹¬ ì£¼ì‹ì„ ì¶”ê°€í•´ë³´ì„¸ìš”</p>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">ğŸ’± ê´€ì‹¬ í™˜ìœ¨</h2>
                    <button class="add-btn" onclick="openCurrencyModal()">
                        <i class="fas fa-plus"></i> ì¶”ê°€
                    </button>
                </div>
                <div id="currency-list">
                    <div class="empty-state">
                        <i class="fas fa-exchange-alt"></i>
                        <p>ê´€ì‹¬ í™˜ìœ¨ì„ ì¶”ê°€í•´ë³´ì„¸ìš”</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ì•Œë¦¼ íƒ­ -->
        <div id="alerts-tab" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">ğŸ”” ì„¤ì •ëœ ì•Œë¦¼</h2>
                </div>
                <div id="alert-list">
                    <div class="empty-state">
                        <i class="fas fa-bell"></i>
                        <p>ì„¤ì •ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</p>
                        <p style="font-size: 0.8rem; margin-top: 8px;">í¬íŠ¸í´ë¦¬ì˜¤ì—ì„œ ì•Œë¦¼ì„ ì„¤ì •í•´ë³´ì„¸ìš”</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- íˆ¬ìë‰´ìŠ¤ íƒ­ -->
        <div id="news-tab" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">ğŸ“° íˆ¬ì ë‰´ìŠ¤</h2>
                    <button class="add-btn" onclick="refreshNews()">
                        <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
                <div id="news-list">
                    <!-- ë‰´ìŠ¤ ëª©ë¡ì´ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- ì£¼ì‹ ê²€ìƒ‰ ëª¨ë‹¬ -->
    <div id="stock-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ì£¼ì‹ ê²€ìƒ‰</h3>
                <button class="close-btn" onclick="closeStockModal()">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">ì¢…ëª©ëª… ë˜ëŠ” ì‹¬ë³¼</label>
                <input type="text" class="form-input" id="stock-search" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì, AAPL, ì½”ì–´ìœ„ë¸Œ" onkeypress="handleEnterKey(event)">
                <div id="stock-results" class="search-results" style="display: none;"></div>
            </div>
        </div>
    </div>
    
    <!-- í™˜ìœ¨ ê²€ìƒ‰ ëª¨ë‹¬ -->
    <div id="currency-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">í™˜ìœ¨ ê²€ìƒ‰</h3>
                <button class="close-btn" onclick="closeCurrencyModal()">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">í™˜ìœ¨ ì„ íƒ</label>
                <select class="form-select" id="currency-select">
                    <option value="">í™˜ìœ¨ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="USD/KRW">USD/KRW (ë‹¬ëŸ¬/ì›)</option>
                    <option value="EUR/KRW">EUR/KRW (ìœ ë¡œ/ì›)</option>
                    <option value="JPY/KRW">JPY/KRW (ì—”/ì›)</option>
                    <option value="GBP/KRW">GBP/KRW (íŒŒìš´ë“œ/ì›)</option>
                    <option value="CNY/KRW">CNY/KRW (ìœ„ì•ˆ/ì›)</option>
                </select>
            </div>
            <button class="btn-primary" onclick="addSelectedCurrency()">í™˜ìœ¨ ì¶”ê°€</button>
        </div>
    </div>
    
    <!-- ì•Œë¦¼ ì„¤ì • ëª¨ë‹¬ -->
    <div id="alert-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ì•Œë¦¼ ì„¤ì •</h3>
                <button class="close-btn" onclick="closeAlertModal()">&times;</button>
            </div>
            <div id="alert-form">
                <!-- ì•Œë¦¼ ì„¤ì • í¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>
    
    <!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ -->
    <div id="toast" class="toast"></div>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let watchlistStocks = JSON.parse(localStorage.getItem('watchlistStocks') || '[]');
        let watchlistCurrencies = JSON.parse(localStorage.getItem('watchlistCurrencies') || '[]');
        let alerts = JSON.parse(localStorage.getItem('alerts') || '[]');
        let currentAlertItem = null;
        
        // API ì„¤ì •
        const API_BASE_URL = 'http://localhost:8000';
        const API_ENDPOINTS = {
            stock_search: `${API_BASE_URL}/naver/stocks/search`,
            currency_search: `${API_BASE_URL}/naver/currencies/search`,
            stock_alert: `${API_BASE_URL}/alerts/test/stock`,  // ğŸ”§ ìƒˆë¡œìš´ í…ŒìŠ¤íŠ¸ ì—”ë“œí¬ì¸íŠ¸
            currency_alert: `${API_BASE_URL}/alerts/test/currency`,  // ğŸ”§ ìƒˆë¡œìš´ í…ŒìŠ¤íŠ¸ ì—”ë“œí¬ì¸íŠ¸
            stock_alerts_list: `${API_BASE_URL}/alerts/test/stock`  // ğŸ”§ ìƒˆë¡œìš´ í…ŒìŠ¤íŠ¸ ì—”ë“œí¬ì¸íŠ¸
        };
        
        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // ì„ íƒëœ íƒ­ í™œì„±í™”
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // íƒ­ë³„ ë°ì´í„° ë¡œë“œ
            if (tabName === 'portfolio') {
                loadWatchlist();
            } else if (tabName === 'alerts') {
                loadAlerts();
            } else if (tabName === 'news') {
                loadNews();
            }
        }
        
        // ê´€ì‹¬ì¢…ëª© ë¡œë“œ
        function loadWatchlist() {
            loadStockWatchlist();
            loadCurrencyWatchlist();
            loadInitialPrices();
        }
        
        // UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateStockUI(stock) {
            const stockRow = document.querySelector(`[data-symbol="${stock.symbol}"]`);
            if (stockRow) {
                const priceCell = stockRow.querySelector('.current-price');
                const changeCell = stockRow.querySelector('.change-percent');
                
                if (priceCell) priceCell.textContent = formatPrice(stock.current_price);
                if (changeCell) {
                    changeCell.textContent = `${stock.change_percent}%`;
                    changeCell.classList.remove('positive', 'negative');
                    changeCell.classList.add(stock.change_percent >= 0 ? 'positive' : 'negative');
                }
            }
        }
        
        // ê´€ì‹¬ì¢…ëª© ê°€ê²© í‘œì‹œ (ì´ˆê¸° ë¡œë“œ ì‹œì—ë§Œ)
        async function loadInitialPrices() {
            try {
                // ì£¼ì‹ ê°€ê²© ë¡œë“œ
                if (watchlistStocks && watchlistStocks.length > 0) {
                    watchlistStocks = watchlistStocks.filter(stock => stock);
                    
                    for (let stock of watchlistStocks) {
                        try {
                            const response = await fetch(`${API_BASE_URL}/naver/stocks/search/${encodeURIComponent(stock.symbol)}`);
                            if (response.ok) {
                                const data = await response.json();
                                if (data && data.results && data.results.length > 0) {
                                    const stockData = data.results[0];
                                    stock.current_price = stockData.current_price;
                                    stock.change_percent = stockData.change_percent;
                                    updateStockUI(stock);
                                }
                            }
                        } catch (error) {
                            console.error(`ì£¼ì‹ ${stock.symbol} ê°€ê²© ë¡œë“œ ì‹¤íŒ¨:`, error);
                        }
                    }
                }

                // í™˜ìœ¨ ê°€ê²© ë¡œë“œ
                if (watchlistCurrencies && watchlistCurrencies.length > 0) {
                    watchlistCurrencies = watchlistCurrencies.filter(currency => currency);
                    
                    for (let currency of watchlistCurrencies) {
                        try {
                            const response = await fetch(`${API_BASE_URL}/naver/currency/rate/${currency.from}/${currency.to}`);
                            if (response.ok) {
                                const data = await response.json();
                                currency.current_rate = data.rate;
                                updateCurrencyUI(currency);
                            }
                        } catch (error) {
                            console.error(`í™˜ìœ¨ ${currency.from}/${currency.to} ë¡œë“œ ì‹¤íŒ¨:`, error);
                        }
                    }
                }

                // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
                localStorage.setItem('watchlistStocks', JSON.stringify(watchlistStocks));
                localStorage.setItem('watchlistCurrencies', JSON.stringify(watchlistCurrencies));

                // UI ì—…ë°ì´íŠ¸
                loadStockWatchlist();
                loadCurrencyWatchlist();

            } catch (error) {
                console.error('ê°€ê²© ë¡œë“œ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜:', error);
            }
        }
        
        function loadStockWatchlist() {
            const container = document.getElementById('stock-list');
            
            if (watchlistStocks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-chart-line"></i>
                        <p>ê´€ì‹¬ ì£¼ì‹ì„ ì¶”ê°€í•´ë³´ì„¸ìš”</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = watchlistStocks.map(stock => {
                const stockAlerts = alerts.filter(a => a.symbol === stock.symbol && a.type === 'stock');
                const alertText = stockAlerts.length > 0 
                    ? `${stockAlerts.length}ê°œ ì•Œë¦¼: ${stockAlerts.map(a => `${a.condition === 'above' ? '+' : '-'}${a.value}%`).join(', ')}`
                    : 'ì•Œë¦¼ ì—†ìŒ';
                
                return `
                    <div class="stock-card">
                        <div class="stock-header">
                            <div class="stock-info">
                                <h3>${stock.name_kr || stock.name}</h3>
                                <p>${stock.symbol} â€¢ ${stock.market || 'KOSPI'}</p>
                            </div>
                            <div class="stock-price">
                                <div class="price">${formatPrice(stock.current_price)}</div>
                                <div class="change ${stock.change_percent >= 0 ? 'positive' : 'negative'}">
                                    ${stock.change_percent >= 0 ? '+' : ''}${stock.change_percent.toFixed(2)}%
                                </div>
                            </div>
                        </div>
                        <div class="stock-actions">
                            <div class="alert-status ${stockAlerts.length > 0 ? 'alert-active' : ''}">${alertText}</div>
                            <div class="action-btns">
                                <button class="btn-small btn-alert" onclick="openAlertModal('${stock.symbol}', 'stock')">
                                    <i class="fas fa-bell"></i> ${stockAlerts.length > 0 ? 'ì•Œë¦¼ ì¶”ê°€' : 'ì•Œë¦¼ ì„¤ì •'}
                                </button>
                                <button class="btn-small" onclick="removeFromWatchlist('${stock.symbol}', 'stock')">
                                    <i class="fas fa-trash"></i> ì‚­ì œ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function loadCurrencyWatchlist() {
            const container = document.getElementById('currency-list');
            
            if (watchlistCurrencies.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exchange-alt"></i>
                        <p>ê´€ì‹¬ í™˜ìœ¨ì„ ì¶”ê°€í•´ë³´ì„¸ìš”</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = watchlistCurrencies.map(currency => {
                const currencyAlerts = alerts.filter(a => a.symbol === currency.symbol && a.type === 'currency');
                const alertText = currencyAlerts.length > 0 
                    ? `${currencyAlerts.length}ê°œ ì•Œë¦¼: ${currencyAlerts.map(a => `${a.condition === 'above' ? 'â†‘' : 'â†“'}${a.value}ì›`).join(', ')}`
                    : 'ì•Œë¦¼ ì—†ìŒ';
                
                return `
                    <div class="stock-card">
                        <div class="stock-header">
                            <div class="stock-info">
                                <h3>${currency.name}</h3>
                                <p>${currency.symbol}</p>
                            </div>
                            <div class="stock-price">
                                <div class="price">${formatPrice(currency.current_rate)}ì›</div>
                                <div class="change ${currency.change_percent >= 0 ? 'positive' : 'negative'}">
                                    ${currency.change_percent >= 0 ? '+' : ''}${currency.change_percent.toFixed(2)}%
                                </div>
                            </div>
                        </div>
                        <div class="stock-actions">
                            <div class="alert-status ${currencyAlerts.length > 0 ? 'alert-active' : ''}">${alertText}</div>
                            <div class="action-btns">
                                <button class="btn-small btn-alert" onclick="openAlertModal('${currency.symbol}', 'currency')">
                                    <i class="fas fa-bell"></i> ${currencyAlerts.length > 0 ? 'ì•Œë¦¼ ì¶”ê°€' : 'ì•Œë¦¼ ì„¤ì •'}
                                </button>
                                <button class="btn-small" onclick="removeFromWatchlist('${currency.symbol}', 'currency')">
                                    <i class="fas fa-trash"></i> ì‚­ì œ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ì•Œë¦¼ ëª©ë¡ ë¡œë“œ
        function loadAlerts() {
            const container = document.getElementById('alert-list');
            
            if (alerts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell"></i>
                        <p>ì„¤ì •ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</p>
                        <p style="font-size: 0.8rem; margin-top: 8px;">í¬íŠ¸í´ë¦¬ì˜¤ì—ì„œ ì•Œë¦¼ì„ ì„¤ì •í•´ë³´ì„¸ìš”</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = alerts.map(alert => {
                const item = alert.type === 'stock' 
                    ? watchlistStocks.find(s => s.symbol === alert.symbol)
                    : watchlistCurrencies.find(c => c.symbol === alert.symbol);
                
                const name = item ? (item.name_kr || item.name) : alert.symbol;
                const currentPrice = item ? item.current_price : 0;
                
                let conditionText = '';
                if (alert.type === 'stock') {
                    const percentageText = alert.percentage_change ? `${alert.percentage_change}%` : '';
                    const calculatedPriceText = alert.calculated_price ? `(${formatPrice(alert.calculated_price)}ì›)` : '';
                    conditionText = `ğŸ“ˆ ${alert.condition === 'above' ? 'ìƒìŠ¹' : 'í•˜ë½'} ${percentageText} ${calculatedPriceText} ë„ë‹¬ ì‹œ ì•Œë¦¼`;
                } else {
                    conditionText = `ğŸ’± í™˜ìœ¨ ${formatPrice(alert.value)}ì› ${alert.condition === 'above' ? 'ì´ìƒ' : 'ì´í•˜'}ì¼ ë•Œ ì•Œë¦¼`;
                }
                
                return `
                    <div class="alert-card">
                        <h4>${name}</h4>
                        <div class="alert-condition">${conditionText}</div>
                        <div class="alert-time">
                            í˜„ì¬ê°€: ${formatPrice(currentPrice)}ì›<br>
                            ì„¤ì •ì¼: ${new Date(alert.created).toLocaleDateString()}
                        </div>
                        <div style="margin-top: 12px;">
                            <button class="btn-small" onclick="deleteAlert('${alert.server_id}')">
                                <i class="fas fa-trash"></i> ì‚­ì œ
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ë‰´ìŠ¤ ë¡œë“œ
        function loadNews() {
            const container = document.getElementById('news-list');
            
            // ì‹œë®¬ë ˆì´ì…˜ ë‰´ìŠ¤ ë°ì´í„°
            const newsData = [
                {
                    title: "ì‚¼ì„±ì „ì, 3ë¶„ê¸° ì‹¤ì  ì‹œì¥ ê¸°ëŒ€ì¹˜ ìƒíšŒ",
                    summary: "ì‚¼ì„±ì „ìê°€ 3ë¶„ê¸° ì˜ì—…ì´ìµì´ ì‹œì¥ ê¸°ëŒ€ì¹˜ë¥¼ ìƒíšŒí–ˆë‹¤ê³  ë°œí‘œí–ˆìŠµë‹ˆë‹¤. ë©”ëª¨ë¦¬ ë°˜ë„ì²´ ê°€ê²© ìƒìŠ¹ì´ ì£¼ìš” ìš”ì¸ìœ¼ë¡œ...",
                    source: "í•œêµ­ê²½ì œ",
                    time: "2ì‹œê°„ ì „",
                    icon: "fas fa-microchip"
                },
                {
                    title: "ë¯¸êµ­ ì—°ì¤€, ê¸°ì¤€ê¸ˆë¦¬ ë™ê²° ê²°ì •",
                    summary: "ë¯¸êµ­ ì—°ë°©ì¤€ë¹„ì œë„ê°€ ê¸°ì¤€ê¸ˆë¦¬ë¥¼ í˜„ ìˆ˜ì¤€ì—ì„œ ë™ê²°í•˜ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤. ì¸í”Œë ˆì´ì…˜ ë‘”í™” ì†ë„ë¥¼ ì§€ì¼œë³´ê² ë‹¤ê³ ...",
                    source: "ì—°í•©ë‰´ìŠ¤",
                    time: "4ì‹œê°„ ì „",
                    icon: "fas fa-university"
                },
                {
                    title: "í…ŒìŠ¬ë¼, ìƒˆë¡œìš´ ììœ¨ì£¼í–‰ ê¸°ìˆ  ê³µê°œ",
                    summary: "í…ŒìŠ¬ë¼ê°€ ì™„ì „ ììœ¨ì£¼í–‰ì„ ìœ„í•œ ìƒˆë¡œìš´ AI ê¸°ìˆ ì„ ê³µê°œí–ˆìŠµë‹ˆë‹¤. ì´ë²ˆ ê¸°ìˆ ë¡œ ììœ¨ì£¼í–‰ ì™„ì„±ë„ê°€ í¬ê²Œ...",
                    source: "í…Œí¬í¬ëŸ°ì¹˜",
                    time: "6ì‹œê°„ ì „",
                    icon: "fas fa-car"
                },
                {
                    title: "ë¹„íŠ¸ì½”ì¸, 4ë§Œ ë‹¬ëŸ¬ ëŒíŒŒ",
                    summary: "ë¹„íŠ¸ì½”ì¸ì´ ë‹¤ì‹œ 4ë§Œ ë‹¬ëŸ¬ë¥¼ ëŒíŒŒí•˜ë©° ìƒìŠ¹ì„¸ë¥¼ ì´ì–´ê°€ê³  ìˆìŠµë‹ˆë‹¤. ê¸°ê´€ íˆ¬ììë“¤ì˜ ê´€ì‹¬ì´ ë†’ì•„ì§€ë©´ì„œ...",
                    source: "ì½”ì¸ë°ìŠ¤í¬",
                    time: "8ì‹œê°„ ì „",
                    icon: "fab fa-bitcoin"
                },
                {
                    title: "ì• í”Œ, ìƒˆë¡œìš´ iPhone 15 ì‹œë¦¬ì¦ˆ ì¶œì‹œ",
                    summary: "ì• í”Œì´ iPhone 15 ì‹œë¦¬ì¦ˆë¥¼ ê³µì‹ ì¶œì‹œí–ˆìŠµë‹ˆë‹¤. USB-C í¬íŠ¸ ì±„íƒê³¼ í•¨ê»˜ ì¹´ë©”ë¼ ì„±ëŠ¥ì´ ëŒ€í­ í–¥ìƒë˜ì—ˆë‹¤ê³ ...",
                    source: "ë§¤í¬ë£¨ë¨¸ìŠ¤",
                    time: "12ì‹œê°„ ì „",
                    icon: "fab fa-apple"
                }
            ];
            
            container.innerHTML = newsData.map(news => `
                <div class="news-card" onclick="openNews('${news.title}')">
                    <div class="news-header">
                        <div class="news-image">
                            <i class="${news.icon}"></i>
                        </div>
                        <div class="news-content">
                            <div class="news-title">${news.title}</div>
                            <div class="news-summary">${news.summary}</div>
                            <div class="news-meta">
                                <span>${news.source}</span>
                                <span>${news.time}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // ë‰´ìŠ¤ ìƒˆë¡œê³ ì¹¨
        function refreshNews() {
            showToast('ë‰´ìŠ¤ë¥¼ ìƒˆë¡œê³ ì¹¨í–ˆìŠµë‹ˆë‹¤');
            loadNews();
        }
        
        // ë‰´ìŠ¤ ì—´ê¸°
        function openNews(title) {
            showToast(`ë‰´ìŠ¤ ì—´ê¸°: ${title}`);
        }
        
        // ì£¼ì‹ ê²€ìƒ‰ ëª¨ë‹¬
        function openStockModal() {
            document.getElementById('stock-modal').style.display = 'block';
            document.getElementById('stock-search').focus();
        }
        
        function closeStockModal() {
            document.getElementById('stock-modal').style.display = 'none';
            document.getElementById('stock-search').value = '';
            document.getElementById('stock-results').style.display = 'none';
        }
        
        // í™˜ìœ¨ ê²€ìƒ‰ ëª¨ë‹¬
        function openCurrencyModal() {
            document.getElementById('currency-modal').style.display = 'block';
        }
        
        function closeCurrencyModal() {
            document.getElementById('currency-modal').style.display = 'none';
            document.getElementById('currency-select').value = '';
        }
        
        // ì•Œë¦¼ ì„¤ì • ëª¨ë‹¬
        function openAlertModal(symbol, type) {
            // ë§¤ê°œë³€ìˆ˜ ìœ íš¨ì„± ê²€ì‚¬
            if (!symbol || !type) {
                console.error('âŒ openAlertModal: Invalid parameters', { symbol, type });
                showToast('âŒ ì•Œë¦¼ ì„¤ì • ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            currentAlertItem = { symbol, type };
            
            const item = type === 'stock' 
                ? watchlistStocks.find(s => s.symbol === symbol)
                : watchlistCurrencies.find(c => c.symbol === symbol);
            
            // itemì´ ì—†ì„ ë•Œ ì²˜ë¦¬
            if (!item) {
                console.error('âŒ openAlertModal: Item not found', { symbol, type });
                showToast('âŒ í•´ë‹¹ ì¢…ëª©/í™˜ìœ¨ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì£¼ì‹ê³¼ í™˜ìœ¨ì— ë”°ë¼ ë‹¤ë¥¸ í¼ í‘œì‹œ
            const formHtml = type === 'stock' 
                ? `
                    <div class="form-group">
                        <label class="form-label">ğŸ“ˆ ${item.name_kr || item.name} ì£¼ì‹ ì•Œë¦¼</label>
                        <p style="color: #666; font-size: 12px; margin: 5px 0;">ì£¼ì‹ ê°€ê²© ë³€ë™ë¥  ê¸°ì¤€ìœ¼ë¡œ ì•Œë¦¼ì„ ì„¤ì •í•©ë‹ˆë‹¤</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì•Œë¦¼ ì¡°ê±´</label>
                        <select class="form-select" id="alert-condition">
                            <option value="above">ğŸ“ˆ ìƒìŠ¹ (ì§€ì •í•œ % ì´ìƒ ì˜¤ë¥¼ ë•Œ)</option>
                            <option value="below">ğŸ“‰ í•˜ë½ (ì§€ì •í•œ % ì´ìƒ ë–¨ì–´ì§ˆ ë•Œ)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ë³€ë™ë¥  (%)</label>
                        <input type="number" class="form-input" id="alert-value" placeholder="ì˜ˆ: 5 (5% ë³€ë™ ì‹œ ì•Œë¦¼)" step="0.1" min="0.1">
                        <small style="color: #666;">í˜„ì¬ê°€ ëŒ€ë¹„ ë³€ë™ë¥ ì„ ì…ë ¥í•˜ì„¸ìš”</small>
                    </div>
                    <button class="btn-primary" onclick="saveAlert()">ğŸ“± ì£¼ì‹ ì•Œë¦¼ ì„¤ì •</button>
                `
                : `
                    <div class="form-group">
                        <label class="form-label">ğŸ’± ${item.name} í™˜ìœ¨ ì•Œë¦¼</label>
                        <p style="color: #666; font-size: 12px; margin: 5px 0;">íŠ¹ì • í™˜ìœ¨ ê°€ê²©ì— ë„ë‹¬í•˜ë©´ ì•Œë¦¼ì„ ë°›ìŠµë‹ˆë‹¤</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì•Œë¦¼ ì¡°ê±´</label>
                        <select class="form-select" id="alert-condition">
                            <option value="above">â¬†ï¸ í™˜ìœ¨ì´ ì§€ì • ê°€ê²© ì´ìƒì¼ ë•Œ</option>
                            <option value="below">â¬‡ï¸ í™˜ìœ¨ì´ ì§€ì • ê°€ê²© ì´í•˜ì¼ ë•Œ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ğŸ¯ ëª©í‘œ í™˜ìœ¨ (ì›)</label>
                        <input type="number" class="form-input" id="alert-value" placeholder="ì˜ˆ: 1300 (1ë‹¬ëŸ¬ = 1300ì› ì‹œ ì•Œë¦¼)" step="1" min="1">
                        <small style="color: #666;">ì›í•˜ëŠ” í™˜ìœ¨ ê°€ê²©ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: USD/KRW 1300ì›)</small>
                    </div>
                    <button class="btn-primary" onclick="saveAlert()">ğŸ“± í™˜ìœ¨ ì•Œë¦¼ ì„¤ì •</button>
                `;
            
            document.getElementById('alert-form').innerHTML = formHtml;
            document.getElementById('alert-modal').style.display = 'block';
        }
        
        function closeAlertModal() {
            document.getElementById('alert-modal').style.display = 'none';
            currentAlertItem = null;
        }
        
        // ì•Œë¦¼ ì €ì¥ (ë°±ì—”ë“œ API + localStorage)
        async function saveAlert() {
            if (!currentAlertItem) {
                console.error('âŒ currentAlertItem is null');
                showToast('âŒ ì•Œë¦¼ ì„¤ì • ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const condition = document.getElementById('alert-condition').value;
            const value = parseFloat(document.getElementById('alert-value').value);
            
            if (!value || value <= 0) {
                showToast('ì˜¬ë°”ë¥¸ ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            // í˜„ì¬ ê°€ê²© ê°€ì ¸ì˜¤ê¸°
            const item = currentAlertItem.type === 'stock' 
                ? watchlistStocks.find(s => s.symbol === currentAlertItem.symbol)
                : watchlistCurrencies.find(c => c.symbol === currentAlertItem.symbol);
            
            if (!item) {
                showToast('âŒ ì¢…ëª© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!item.current_price) {
                showToast('âŒ í˜„ì¬ ê°€ê²© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ê³„ì‚°ëœ ëª©í‘œê°€ ì„¤ì •
            const currentPrice = parseFloat(item.current_price);
            let calculatedPrice;
            
            if (currentAlertItem.type === 'stock') {
                // ì£¼ì‹: í˜„ì¬ê°€ ê¸°ì¤€ í¼ì„¼íŠ¸ ê³„ì‚°
                calculatedPrice = condition === 'above'
                    ? currentPrice * (1 + value / 100)  // ìƒìŠ¹ ëª©í‘œê°€
                    : currentPrice * (1 - value / 100); // í•˜ë½ ëª©í‘œê°€
            } else {
                // í™˜ìœ¨: ì§ì ‘ ì…ë ¥í•œ ëª©í‘œê°€ ì‚¬ìš©
                calculatedPrice = value;
            }
            
            // ì™„ì „íˆ ë™ì¼í•œ ì•Œë¦¼ë§Œ ì¤‘ë³µ ë°©ì§€ (ê°™ì€ ì¢…ëª©, ê°™ì€ ì¡°ê±´, ê°™ì€ ê°’)
            const existingAlert = alerts.find(a => 
                a.symbol === currentAlertItem.symbol && 
                a.type === currentAlertItem.type && 
                a.condition === condition && 
                a.value === value
            );
            
            if (existingAlert) {
                showToast('ë™ì¼í•œ ì¡°ê±´ì˜ ì•Œë¦¼ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤');
                return;
            }
            
            // ìƒˆ ì•Œë¦¼ ìƒì„±
            const newAlert = {
                id: Date.now().toString(),
                symbol: currentAlertItem.symbol,
                type: currentAlertItem.type,
                condition: condition,
                value: value,
                percentage_change: currentAlertItem.type === 'stock' ? value : null,  // ì£¼ì‹ì˜ ê²½ìš° í¼ì„¼íŠ¸ ë³€í™”ìœ¨ ì €ì¥
                calculated_price: calculatedPrice,  // ê³„ì‚°ëœ ëª©í‘œê°€ ì €ì¥
                created: new Date().toISOString()
            };

            try {
                // API ì„œë²„ì˜ í…ŒìŠ¤íŠ¸ ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
                const apiEndpoint = currentAlertItem.type === 'stock' 
                    ? API_ENDPOINTS.stock_alert
                    : API_ENDPOINTS.currency_alert;

                // API ìš”ì²­ ë°ì´í„° êµ¬ì¡°ë¥¼ íƒ€ì…ë³„ë¡œ ë¶„ë¦¬
                const requestData = currentAlertItem.type === 'stock' ? {
                    stock_symbol: currentAlertItem.symbol,
                    target_price: calculatedPrice,  // ê³„ì‚°ëœ ëª©í‘œê°€ ì „ì†¡
                    condition: condition,
                    percentage_change: value  // í¼ì„¼íŠ¸ ë³€í™”ìœ¨ë„ í•¨ê»˜ ì „ì†¡
                } : {
                    base_currency: currentAlertItem.symbol.split('/')[0],
                    target_currency: currentAlertItem.symbol.split('/')[1],
                    target_rate: value,
                    condition: condition
                };

                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'API í˜¸ì¶œ ì‹¤íŒ¨');
                }

                const result = await response.json();
                console.log('âœ… ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì„±ê³µ:', result);

                // ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì„±ê³µ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ë„ ì €ì¥
                newAlert.server_id = result.id;
                alerts.push(newAlert);
                localStorage.setItem('alerts', JSON.stringify(alerts));
                
                const alertMessage = currentAlertItem.type === 'stock' 
                    ? `ğŸ‰ ì£¼ì‹ ì•Œë¦¼ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤: ${value}% ${condition === 'above' ? 'ìƒìŠ¹' : 'í•˜ë½'} ì‹œ (${formatPrice(calculatedPrice)}ì›)`
                    : `ğŸ‰ í™˜ìœ¨ ì•Œë¦¼ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤: ${formatPrice(value)}ì› ${condition === 'above' ? 'ì´ìƒ' : 'ì´í•˜'}`;
                
                showToast(alertMessage);
                closeAlertModal();
                loadAlerts();
                loadWatchlist();
            } catch (error) {
                console.error('âŒ ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì‹¤íŒ¨:', error);
                showToast(`âŒ ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
            }
        }
        
        // ì•Œë¦¼ ì‚­ì œ
        async function deleteAlert(alertId) {
            try {
                // ì„œë²„ì—ì„œ ì•Œë¦¼ ì‚­ì œ
                const response = await fetch(`${API_ENDPOINTS.stock_alert}/${alertId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // ë¡œì»¬ alerts ë°°ì—´ì—ì„œë„ ì œê±°
                    alerts = alerts.filter(alert => alert.server_id !== alertId);
                    localStorage.setItem('alerts', JSON.stringify(alerts));
                    
                    // UI ì—…ë°ì´íŠ¸
                    loadAlerts();
                    loadWatchlist();
                    
                    showToast('âœ… ì•Œë¦¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    showToast('âŒ ì•Œë¦¼ ì‚­ì œ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('ì•Œë¦¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
                showToast('âŒ ì•Œë¦¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            }
        }
        
        // ì—”í„°í‚¤ ì²˜ë¦¬
        function handleEnterKey(event) {
            if (event.key === 'Enter' || event.keyCode === 13) {
                event.preventDefault();
                const query = document.getElementById('stock-search').value.trim();
                if (query.length > 0) {
                    showToast(`ğŸ” "${query}" ê²€ìƒ‰ ì¤‘...`);
                    searchStocks();
                }
            }
        }

        // ì£¼ì‹ ê²€ìƒ‰ (ì‹¤ì œ API í˜¸ì¶œ)
        async function searchStocks() {
            const query = document.getElementById('stock-search').value.trim();
            const resultsContainer = document.getElementById('stock-results');
            
            if (query.length < 1) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            // ë¡œë”© í‘œì‹œ
            resultsContainer.innerHTML = '<div class="search-item">ğŸ” ê²€ìƒ‰ ì¤‘...</div>';
            resultsContainer.style.display = 'block';
            
            try {
                // ë„¤ì´ë²„ ì£¼ì‹ ê²€ìƒ‰ API í˜¸ì¶œ
                const response = await fetch(`http://localhost:8000/naver/stocks/search/${encodeURIComponent(query)}`);
                
                if (!response.ok) {
                    throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨');
                }
                
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    resultsContainer.innerHTML = data.results.map(stock => `
                        <div class="search-item" onclick="addToWatchlist('${stock.symbol}', 'stock', ${JSON.stringify(stock).replace(/"/g, '&quot;')})">
                            <div class="search-info">
                                <h4>${stock.name_kr || stock.name}</h4>
                                <p>${stock.symbol} â€¢ ${stock.market || 'KOSPI'}</p>
                            </div>
                            <div class="search-price">
                                <div>${formatPrice(stock.current_price || 0)}</div>
                                <div class="change ${(stock.change_percent || 0) >= 0 ? 'positive' : 'negative'}">
                                    ${(stock.change_percent || 0) >= 0 ? '+' : ''}${(stock.change_percent || 0).toFixed(2)}%
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    resultsContainer.innerHTML = '<div class="search-item">âŒ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                }
            } catch (error) {
                console.error('ì£¼ì‹ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                
                // í•˜ë“œì½”ë”© ì™„ì „ ì œê±° - API ì‹¤íŒ¨ ì‹œ ëª…í™•í•œ ì•ˆë‚´ë§Œ
                resultsContainer.innerHTML = `
                    <div style="padding: 15px; background: #f8d7da; color: #721c24; border-radius: 8px; font-size: 14px; text-align: center;">
                        âŒ API ì„œë²„ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤<br>
                        <small style="margin-top: 8px; display: block;">í„°ë¯¸ë„: cd backend && python run_server.py</small>
                    </div>
                `;
            }
        }
        
        // ì„ íƒëœ í™˜ìœ¨ ì¶”ê°€ - ì‹¤ì œ ë„¤ì´ë²„ íŒŒì‹±ë§Œ ì‚¬ìš©
        async function addSelectedCurrency() {
            const select = document.getElementById('currency-select');
            const selectedValue = select.value;
            
            if (!selectedValue) {
                showToast('í™˜ìœ¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }
            
            // ì‹¤ì œ ë„¤ì´ë²„ í™˜ìœ¨ íŒŒì‹±ìœ¼ë¡œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            try {
                showToast('ì‹¤ì‹œê°„ í™˜ìœ¨ ë°ì´í„° ì¡°íšŒ ì¤‘...');
                const response = await fetch(`http://localhost:8000/naver/currency/rate/${selectedValue}/KRW`);
                
                if (!response.ok) {
                    throw new Error('í™˜ìœ¨ API í˜¸ì¶œ ì‹¤íŒ¨');
                }
                
                const data = await response.json();
                
                if (data.rate) {
                    const currencyData = {
                        symbol: selectedValue,
                        name: select.options[select.selectedIndex].text,
                        current_rate: data.rate,
                        change_percent: 0, // ì‹¤ì œ ë³€ë™ë¥ ì€ ë‹¤ìŒ ì—…ë°ì´íŠ¸ ì‹œ ê³„ì‚°
                        source: 'naver_real_parsing'
                    };
                    
                    addToWatchlist(selectedValue, 'currency', currencyData);
                } else {
                    throw new Error('í™˜ìœ¨ ë°ì´í„° ì—†ìŒ');
                }
            } catch (error) {
                console.error('í™˜ìœ¨ ì¡°íšŒ ì˜¤ë¥˜:', error);
                showToast('âŒ ì‹¤ì‹œê°„ í™˜ìœ¨ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨ - ì •í™•í•œ ë°ì´í„°ë¥¼ ì œê³µí•  ìˆ˜ ì—†ì–´ ì¶”ê°€ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤');
                return;
            }
        }
        
        // ê´€ì‹¬ì¢…ëª© ì¶”ê°€
        async function addToWatchlist(symbol, type, data) {
            const parsedData = typeof data === 'string' ? JSON.parse(data.replace(/&quot;/g, '"')) : data;
            
            try {
                // ë°±ì—”ë“œ API í˜¸ì¶œ
                const response = await fetch('http://localhost:8000/watchlist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        type: type,
                        name: parsedData.name,
                        name_kr: parsedData.name_kr,
                        market: parsedData.market
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'ê´€ì‹¬ì¢…ëª© ì¶”ê°€ ì‹¤íŒ¨');
                }
                
                // ë°±ì—”ë“œ ì‘ë‹µì´ ì„±ê³µì ì´ë©´ localStorage ì—…ë°ì´íŠ¸
                if (type === 'stock') {
                    watchlistStocks.push(parsedData);
                    localStorage.setItem('watchlistStocks', JSON.stringify(watchlistStocks));
                    closeStockModal();
                } else {
                    watchlistCurrencies.push(parsedData);
                    localStorage.setItem('watchlistCurrencies', JSON.stringify(watchlistCurrencies));
                    closeCurrencyModal();
                }
                
                showToast('ê´€ì‹¬ì¢…ëª©ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
                loadWatchlist();
            } catch (error) {
                console.error('Failed to add to watchlist:', error);
                showToast(`âŒ ${error.message}`);
            }
        }
        
        // ê´€ì‹¬ì¢…ëª© ì œê±°
        async function removeFromWatchlist(symbol, type) {
            try {
                // ë°±ì—”ë“œ API í˜¸ì¶œ
                const response = await fetch(`http://localhost:8000/watchlist/${symbol}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'ê´€ì‹¬ì¢…ëª© ì œê±° ì‹¤íŒ¨');
                }
                
                // ë°±ì—”ë“œ ì‘ë‹µì´ ì„±ê³µì ì´ë©´ localStorage ì—…ë°ì´íŠ¸
                if (type === 'stock') {
                    watchlistStocks = watchlistStocks.filter(s => s.symbol !== symbol);
                    localStorage.setItem('watchlistStocks', JSON.stringify(watchlistStocks));
                } else {
                    watchlistCurrencies = watchlistCurrencies.filter(c => c.symbol !== symbol);
                    localStorage.setItem('watchlistCurrencies', JSON.stringify(watchlistCurrencies));
                }
                
                // ê´€ë ¨ ì•Œë¦¼ë„ ì œê±°
                alerts = alerts.filter(a => !(a.symbol === symbol && a.type === type));
                localStorage.setItem('alerts', JSON.stringify(alerts));
                
                showToast('ê´€ì‹¬ì¢…ëª©ì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
                loadWatchlist();
            } catch (error) {
                console.error('Failed to remove from watchlist:', error);
                showToast(`âŒ ${error.message}`);
            }
        }
        
        // ê°€ê²© í¬ë§·íŒ…
        function formatPrice(price) {
            // null, undefined ì²´í¬
            if (price == null) return '0';
            
            // ë¬¸ìì—´ì„ ìˆ«ìë¡œ ë³€í™˜
            const numPrice = typeof price === 'string' ? parseFloat(price.replace(/[^0-9.-]/g, '')) : price;
            
            // NaN ì²´í¬
            if (isNaN(numPrice)) return '0';
            
            if (numPrice >= 1000) {
                return numPrice.toLocaleString();
            }
            return numPrice.toFixed(2);
        }
        
        // í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°±ì—”ë“œì—ì„œ ê´€ì‹¬ì¢…ëª© ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        async function loadWatchlistFromBackend() {
            try {
                const response = await fetch('http://localhost:8000/watchlist', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch watchlist from backend');
                }
                
                const data = await response.json();
                
                // localStorage ì—…ë°ì´íŠ¸
                watchlistStocks = data.filter(item => item.type === 'stock').map(item => ({
                    symbol: item.symbol,
                    name: item.name,
                    name_kr: item.name_kr,
                    market: item.market,
                    current_price: 0,
                    change_percent: 0
                }));
                
                watchlistCurrencies = data.filter(item => item.type === 'currency').map(item => ({
                    symbol: item.symbol,
                    name: item.name,
                    current_rate: 0,
                    change_percent: 0
                }));
                
                localStorage.setItem('watchlistStocks', JSON.stringify(watchlistStocks));
                localStorage.setItem('watchlistCurrencies', JSON.stringify(watchlistCurrencies));
                
                // UI ì—…ë°ì´íŠ¸
                loadWatchlist();
            } catch (error) {
                console.error('Failed to load watchlist:', error);
                showToast('âŒ ê´€ì‹¬ì¢…ëª© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°±ì—”ë“œì—ì„œ ê´€ì‹¬ì¢…ëª© ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', function() {
            if (localStorage.getItem('access_token')) {
                loadWatchlistFromBackend();
            }
        });
    </script>
</body>
</html> 